#' Getting the project module IDs and their titles
#'
#' Takes the event data from a single participant and returns a table with mail recipients the participant was writing a mail and 4-digit codes
#' for each recipient
#'
#' @param participant_events Tibble including minimally pre-processed log data for a single participation
#' @param mail_recipient_codes Tibble including previously assigned mail recipients and their codes
#'
#' @return A tibble including a completed list of mail recipients used by the participants and their codes for generating
#' more generalized event codes
#'
#'
#' @importFrom dplyr %>%
add_mail_recipients <- function (participant_events, mail_recipient_codes=tibble(recipient=character(), code=character())) {

  # Complete participant's recipient list
  completed_mail_recipient_codes <- participant_events %>%
    dplyr::filter(eventType=="UpdateEmail") %>%
    tidyr::unnest_wider(data) %>%
    dplyr::arrange(desc(timestamp)) %>%
    # Skip the following steps if no emails are present and return incoming mail recipient codes
    { if (nrow(.)==0) {
        mail_recipient_codes
    } else {
        dplyr::distinct(id, .keep_all=TRUE) %>%
        dplyr::distinct(to) %>%
        dplyr::filter(to!="") %>%
        dplyr::select(recipient=to) %>%
        dplyr::full_join(mail_recipient_codes, by="recipient") %>%
        dplyr::arrange(code)
      }
    }

  return(completed_mail_recipient_codes)
}
